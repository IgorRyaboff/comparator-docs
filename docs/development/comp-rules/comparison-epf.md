# Разработка подключаемых обработок сравнения
---
**Подключаемые обработки сравнения** выполняют следующие задачи:

- Нестандартное преобразование реальных значений в выгрузках в значения сравнения и представления;
- Нестандартное сравнение значений ресурсов;
- Нестандартное определение признака равенства двух строк.

## Начало разработки
Так же, как и для [подключаемых обработок выгрузки](data-export-epf.md), разработку рекомендуется начинать на базе шаблона из комплекта поставки - **ШаблонПодключаемойОбработкиСравнения.epf**.

## Программный интерфейс
### Функция ВерсияПрограммногоИнтерфейса
Программный интерфейс подключаемых обработок **версионируется**. Сравнитель версии 1.0.1 работает только с версией "1" программного интерфейса. Это число должна вернуть функция `ВерсияПрограммногоИнтерфейса()`:

```
// Определяет версию программного интерфейса, для которой была написана данная обработка
// 
// Возвращаемое значение:
//  Число - Всегда "1"
Функция ВерсияПрограммногоИнтерфейса() Экспорт
	Возврат 1;
КонецФункции
```

### Процедура ПриВычисленииЗначенияСравнения
Позволяет переопределить вычисляемое значение сравнения.

Стандартный механизм **для ссылочных полей** - преобразование первых 36 символов реального в значение типа УникальныйИдентификатор. Например, реальное значение `65627b2d-b63d-4aba-8c2d-732af7ad34e2 Кондиционер Samsung` станет `65627b2d-b63d-4aba-8c2d-732af7ad34e2`.

Стандартный механизм **для остальных полей** - приведение реального значения к типу значения сравнения.

Параметры процедуры:

- **ИмяТаблицы** - _Строка_ - Имя таблицы из правила сравнения;
- **ИмяПоля** - _Строка_ - Имя поля из таблицы правила сравнения;
- **РеальноеЗначение** - Реальное значение, т.е. значение, переданное из сравниваемой ИБ;
- **ЗначениеСравнения** - Исходящий параметр - результирующее значение сравнения. Изначально заполняется результатом работы стандартного механизма.

Пример реализации:

```
Процедура ПриВычисленииЗначенияСравнения(ИмяТаблицы, ИмяПоля, РеальноеЗначение, ЗначениеСравнения) Экспорт
	Если ИмяТаблицы = "ТоварыОрганизаций" И ИмяПоля = "Контрагент" Тогда
        // Реальное значение - ИНН/КПП и представление, например, "7736207543/770401001;ООО Яндекс"
        ЗначениеСравнения = СтрРазделить(РеальноеЗначение, ";")[0];
    КонецЕсли;
КонецПроцедуры
```

### Процедура ПриВычисленииПредставления
Позволяет переопределить вычисляемое представление.

Стандартный механизм **для ссылочных полей** - из реального значения убираются первые 36 символов (идентификатор ссылки и символ-разделитель). Например, реальное значение `65627b2d-b63d-4aba-8c2d-732af7ad34e2 Кондиционер Samsung` станет `Кондиционер Samsung`.

Стандартный механизм **для остальных полей** - приведение реального значения к типу Строка.

Параметры процедуры:

- **ИмяТаблицы** - _Строка_ - Имя таблицы из правила сравнения;
- **ИмяПоля** - _Строка_ - Имя поля из таблицы правила сравнения;
- **РеальноеЗначение** - Реальное значение, т.е. значение, переданное из сравниваемой ИБ;
- **Представление** - _Строка_ - Исходящий параметр - результирующее представление. Изначально заполняется результатом работы стандартного механизма.

Пример реализации:

```
Процедура ПриВычисленииПредставления(ИмяТаблицы, ИмяПоля, РеальноеЗначение, Представление) Экспорт
	Если ИмяТаблицы = "ТоварыОрганизаций" И ИмяПоля = "Контрагент" Тогда
        // Реальное значение - ИНН/КПП и представление, например, "7736207543/770401001;ООО Яндекс"
        ЧастиЗначенияСравнения = СтрРазделить(РеальноеЗначение, ";");
        ЧастиЗначенияСравнения.Удалить(0);
        ЗначениеСравнения = СтрСоединить(ЧастиЗначенияСравнения, ";");
    КонецЕсли;
КонецПроцедуры
```
### Процедура ПриСравненииРесурса
Переопределяет стандартный механизм сравнения значений ресурсов.

Стандартный механизм - *значения ресурса из 1-й ИБ и 2-й ИБ равны, если равны их значения сравнения*.

Параметры процедуры:

- **ИмяТаблицы** - _Строка_ - Имя таблицы из правила сравнения;
- **ИмяПоля** - _Строка_ - Имя поля из таблицы правила сравнения;
- **Значение1** - Значение сравнения из строки 1-й ИБ;
- **Значение2** - Значение сравнения из строки 2-й ИБ;
- **ЗначенияРавны** - _Булево_ - Исходящий параметр - признак равенства ресурсов. Изначально заполняется результатом работы стандартного механизма сравнения.

Пример реализации:

```
Процедура ПриСравненииРесурса(ИмяТаблицы, ИмяПоля, Значение1, Значение2, ЗначенияРавны) Экспорт
	Если ИмяТаблицы = "ОстаткиТоваров" И ИмяПоля = "Количество" Тогда
        // Не учитываем расхождения менее 1 единицы
		Разница = Значение1 - Значение2;
		Если Разница < 0 Тогда
			Разница = -Разница;
		КонецЕсли;
		ЗначенияРавны = (Разница <= 1);
	КонецЕсли;
КонецПроцедуры
```
### Процедура ПриСравненииСтрок
Позволяет переопределить стандартный механизм определения признака равенства двух строк (строки из выгрузки 1-й ИБ и строки из выгрузки 2-й ИБ).

Стандартный механизм - *Строки равны, если равны значения всех их ресурсов*.

Параметры процедуры:

- **ИмяТаблицы** - _Строка_ - Имя таблицы из правила сравнения;
- **РеальныеЗначения1** - _Структура_ - Реальные значения строки 1-й ИБ;
- **РеальныеЗначения2** - _Структура_ - Реальные значения строки 2-й ИБ;
- **ЗначенияСравнения1** - _Структура_ - Значения сравнения строки 1-й ИБ;
- **ЗначенияСравнения2** - _Структура_ - Значения сравнения строки 2-й ИБ;
- **СтрокиРавны** - _Булево_ - Исходящий параметр - признак равенства двух строк. Изначально заполняется результатом работы стандартного механизма сравнения.

## Форма отладки
При разработке на базе шаблона из комплекта поставки в обработке также имеется форма отладки. Форма предоставляет возможность вызова всех методов программного интерфейса, описанных выше.

> *Примечание*. Перед вызовом методов через форму отладки установите внутри метода точку останова. Во все процедуры форма отладки передает значение **Неопределено** вместо значений параметров. Их можно задать вручную, используя [функцию изменения значения переменной](https://its.1c.ru/db/v8325doc/bookmark/dev/TI000001615) отладчика Конфигуратора.