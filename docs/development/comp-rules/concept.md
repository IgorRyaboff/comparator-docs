# Концепция правил сравнения
---
**Правила сравнения** являются фундаментом для работы вашего решения для сравнения данных.

Правила сравнения хранят различные **подключаемые обработки**, а также **таблицы правила сравнения**.

## Таблицы правил сравнения
Таблицы описывают промежуточный формат данных, в которые каждая база по своей произвольной логике выгружает данные.

Наполнением таблиц при выгрузке занимаются **подключаемые обработки выгрузки**.

### Измерения и ресурсы в таблицах
Каждое поле должно быть либо **измерением**, либо **ресурсом**.

Измерения предназначены для однозначной идентификации строки таблицы в выгрузке. Именно по комбинации значений измерений производится соотнесение строк двух выгрузок для дальшейшего сравнения данных. Измерением может быть различная нормативно-справочная информация - организации, склады, номенклатура и т.д.

Ресурсы - это носители значений, которые подлежат сравнению.

> **ПРИМЕР:**
> Предположим, что мы передаем в Сравнитель остатки номенклатуры. В этом случае нам потребуется создать таблицу правила сравнения с измерениями "Номенклатура" и "Характеристика", а также с ресурсами "Свободный остаток" и "В резерве".

### Три значения для каждого поля
Для понимания данной концепции будем рассматривать пример - у нас есть поле "Контрагент", которое нужно передавать в Сравнитель. Сложность возникнет при принятии решения о ключевых данных, которые нужно сравнивать и отображать пользователю.

Сразу оговоримся - в нашем примере сравнивать значения контрагентов по уникальным идентификаторам ссылок не получится, контрагенты добавляются в базы независимо.

Сравнивать их по наименованию нельзя с предметной точки зрения - юридические наименования двух совершенно разных юридических лиц могут полностью совпадать. Сравнивать будем по паре значений **ИНН** и **КПП**.

Если в выгрузку в качестве контрагента будет попадать только пара ИНН/КПП, то сравнение будет происходить корректно, однако в таблицах с информацией о расхождениях ничего не будет понятно - у нас будут расхождения по какому-нибудь контрагенту "*7736207543/770401001*". Вряд ли вы сразу узнали, что под этими цифрами скрывается компания "Яндекс".

Хорошо, значит добавим еще и рабочее наименование контрагента. В таком случае может возникнуть другая проблема - в одной базе Яндекс добавили с наименованием "*ЯНДЕКС*", а в другой - "*ООО "Яндекс"*". Если в сравнении двух значений будет участвовать рабочее наименование, то при его несовпадении возникнут проблемы, хотя рабочее наименование не должно мешать данному процессу.

Получается, что нам требуется выгружать и ИНН, и КПП, и рабочее наименование. При этом в сравнении должны участвовать только ИНН и КПП, а выводить пользователю достаточно только рабочее наименование.

В Сравнителе подобная сложная логика реализуется с помощью деления поля на три значения - **реальное значение**, **значение сравнения** и **представление**.

**Реальное значение** - это значение, которое было передано в выгрузку подключаемой обработкой выгрузки.

**Значение сравнения** - вычисляемое перед началом сравнения выгрузок значение, которое используется при сравнении ресурсов, а также соотнесения значений измерений при соотнесении строк двух выгрузок.

**Представление** - вычисляемое после сравнения значение, которое используется для вывода значения поля пользователю при просмотре расхождений.

Для обеспечения большей гибкости, тип реального значения и тип значения сравнения можно задать разными.

Представление всегда является **строкой**.

### Ссылочные поля
Примером выше было рассмотрено произвольное поле, сравниваемое по произвольному правилу, не предопределенному в Сравнителе. Если в качестве значения поля необходимо передать ссылку, а для сравнения значений достаточно использовать уникальные идентификаторы ссылок, то вместо разработки такой логики с нуля следует использовать **ссылочные поля**.

У ссылочного поля предопределены типы значений - реальное значения является **строкой**, а значение сравнения - **уникальным идентификатором**.

Значение для ссылочного поля всегда выгружается в строго определенном формате (*подробнее - в статье о разработке подключаемых обработок выгрузки*). Если значение выгружено правильно, то Сравнитель будет использовать уникальный идентификатор ссылки в качестве значения сравнения, а представление ссылки - только выводить пользователю в расхождениях.